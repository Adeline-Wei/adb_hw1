<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>ISA6120 - Advanced Database System - Assignment #1</title>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap-theme.min.css">
    <script type="text/javascript"
      src="http://maps.google.com/maps/api/js?sensor=false&libraries=drawing"></script>
    <script type="text/javascript" src="wicket.js"></script>
    <script type="text/javascript" src="wicket-gmap3.js"></script>
    <style type="text/css">
      #canvas{
        padding: 0;
        margin: 0;
        height: 100%;
      }
    </style>
    <script type="text/javascript">
      var app = (function () {
          return {
              features: [],
              /**
               * Clears the map contents.
               */
	          clearMap: function () {
	              var i;
  
	              // Reset the remembered last string (so that we can clear the map,
	              //  paste the same string, and see it again)
	              document.getElementById('wkt').last = '';
  
	              for (i in this.features) {
	                  if (this.features.hasOwnProperty(i)) {
	                      this.features[i].setMap(null);
	                  }
	              }
	              this.features.length = 0;
	          },
              /**
               * Clears the current contents of the textarea.
               */
        	  clearText: function () {
        	      document.getElementById('wkt').value = '';
        	  },
              /**
               * Maps the current contents of the textarea.
               * @return  {Object}    Some sort of geometry object
               */
              mapIt: function () {
                  var el, obj, wkt;

                  el = document.getElementById('wkt');
                  wkt = new Wkt.Wkt();

                  if (el.last === el.value) { // Remember the last string
                      return; // Do nothing if the WKT string hasn't changed
                  } else {
                      el.last = el.value;
                  }

                  try { // Catch any malformed WKT strings
                      wkt.read(el.value);
                  } catch (e1) {
                      try {
                          wkt.read(el.value.replace('\n', '').replace('\r', '').replace('\t', ''));
                      } catch (e2) {
                          if (e2.name === 'WKTError') {
                              alert('Wicket could not understand the WKT string you entered. Check that you have parentheses balanced, and try removing tabs and newline characters.');
                              return;
                          }
                      }
                  }

                  obj = wkt.toObject(this.gmap.defaults); // Make an object



                  // Add listeners for overlay editing events
                  if (wkt.type === 'polygon' || wkt.type === 'linestring') {
                      // New vertex is inserted
                      google.maps.event.addListener(obj.getPath(), 'insert_at', function (n) {
                          app.updateText();
                      });
                      // Existing vertex is removed (insertion is undone)
                      google.maps.event.addListener(obj.getPath(), 'remove_at', function (n) {
                          app.updateText();
                      });
                      // Existing vertex is moved (set elsewhere)
                      google.maps.event.addListener(obj.getPath(), 'set_at', function (n) {
                          app.updateText();
                      });
                  } else {
                      if (obj.setEditable) {obj.setEditable(false);}
                  }

	              if (Wkt.isArray(obj)) { // Distinguish multigeometries (Arrays) from objects
	                  for (i in obj) {
	                      if (obj.hasOwnProperty(i) && !Wkt.isArray(obj[i])) {
	                          obj[i].setMap(this.gmap);
	                          this.features.push(obj[i]);
	                      }
	                  }
	              } else {
	                  obj.setMap(this.gmap); // Add it to the map
	                  this.features.push(obj);
	              }

                  // Pan the map to the feature
                  if (obj.getBounds !== undefined && typeof obj.getBounds === 'function') {
                      // For objects that have defined bounds or a way to get them
                      this.gmap.fitBounds(obj.getBounds());
                  } else {
                      if (obj.getPath !== undefined && typeof obj.getPath === 'function') {
                      // For Polygons and Polylines
                      this.gmap.panTo(obj.getPath().getAt(0));
                      } else { // But points (Markers) are different
                          if (obj.getPosition !== undefined && typeof obj.getPosition === 'function') {
                              this.gmap.panTo(obj.getPosition());
                          }
                      }
                  }


                  return obj;
              },
              /**
               * Updates the textarea based on the first available feature.
               */
              updateText: function () {
                  var wkt = new Wkt.Wkt();
                  wkt.fromObject(this.features[0] );
                  document.getElementById('wkt').value = wkt.write();
              },
              /**
               * Application entry point.
               * @return  {<google.maps.Map>} The Google Maps API instance
               */
              init: function () {
                  var gmap;

                  gmap = new google.maps.Map(document.getElementById('canvas'), {
                      center: new google.maps.LatLng(30, 10),
                      defaults: {
                          icon: 'red_dot.png',
                          shadow: 'dot_shadow.png',
                          editable: true,
                          strokeColor: '#990000',
                          fillColor: '#EEFFCC',
                          fillOpacity: 0.6
                      },
                      disableDefaultUI: true,
                      mapTypeControl: false,
                      panControl: false,
                      streetViewControl: false,
                      zoom: 2,
                      zoomControl: true,
                      zoomControlOptions: {
                          position: google.maps.ControlPosition.LEFT_TOP,
                          style: google.maps.ZoomControlStyle.SMALL
                      }
                  });

        	      google.maps.event.addListener(gmap, 'tilesloaded', function () {
        	          if (!this.loaded) {
        	              this.loaded = true;
        	              // NOTE: We start with a MULTIPOLYGON; these aren't easily deconstructed, so we won't set this object to be 	  editable in this example
        	              document.getElementById('wkt').value = 'MULTIPOLYGON (((40 40, 20 45, 45 30, 40 40)), ((20 35, 45 20, 30 5, 	  10 10, 10 30, 20 35), (30 20, 20 25, 20 15, 30 20)))';
        	              app.mapIt();
        	          }
        	      });
  
                  gmap.drawingManager = new google.maps.drawing.DrawingManager({
                      drawingControlOptions: {
                          position: google.maps.ControlPosition.TOP_CENTER,
                          drawingModes: [
                              google.maps.drawing.OverlayType.POLYGON,
                              google.maps.drawing.OverlayType.RECTANGLE
                          ]
                      },
                      polygonOptions: gmap.defaults,
                      rectangleOptions: gmap.defaults
                  });
                  gmap.drawingManager.setMap(gmap);
                  //google.maps.event.addDomListener(document.getElementById('delete-button'), 'click', app.deleteSelectedShape);
    	          google.maps.event.addListener(gmap.drawingManager, 'overlaycomplete', function (event) {
    	              var wkt;
    
  	              app.clearText();
    	              app.clearMap();
    
  	              // Set the drawing mode to "pan" (the hand) so users can immediately edit
    	              this.setDrawingMode(null);
    
  	              // Polygon drawn
    	              if (event.type === google.maps.drawing.OverlayType.POLYGON || event.type === google.maps.drawing.OverlayType.    POLINE) {
    	                  // New vertex is inserted
    	                  google.maps.event.addListener(event.overlay.getPath(), 'insert_at', function (n) {
    	                      app.updateText();
    	                  });
    
  	                  // Existing vertex is removed (insertion is undone)
    	                  google.maps.event.addListener(event.overlay.getPath(), 'remove_at', function (n) {
    	                      app.updateText();
    	                  });
    
  	                  // Existing vertex is moved (set elsewhere)
    	                  google.maps.event.addListener(event.overlay.getPath(), 'set_at', function (n) {
    	                      app.updateText();
    	                  });
    	              } else if (event.type === google.maps.drawing.OverlayType.RECTANGLE) { // Rectangle drawn
    	                  // Listen for the 'bounds_changed' event and update the geometry
    	                  google.maps.event.addListener(event.overlay, 'bounds_changed', function () {
    	                      app.updateText();
    	                  });
    	              }
    
  	              app.features.push(event.overlay);
    	              wkt = new Wkt.Wkt();
    	              wkt.fromObject(event.overlay);
    	              document.getElementById('wkt').value = wkt.write();
    	              });
    
  	          return gmap;
    	      }
    	  };
    	}()); // Execute immediatel
    </script>
  </head>

  <body onload="app.gmap=app.init();">
    <div class="container" style="margin-top:20px;">
      <div class="row row-offcanvas row-offcanvas-right">

        <div class="col-xs-12 col-sm-7">
          <div id="canvas" style="width:600px;height:500px;"></div>
        </div><!--/.col-xs-12.col-sm-9-->

        <div class="col-xs-5 col-sm-5" id="applist">
          <h3>Well-known text (WKT)</h3>
          <textarea class="form-control" rows="10" id="wkt" readonly="true" style="margin-bottom:10px;" placeholder="WKT Format..."></textarea>

          <div class="alert alert-info">When you create an area sucessfully, we will also pick some apps into this area randomly.</div>
          <hr/>
          <center>
          <button class="btn btn-danger" id="delete-button" onClick="app.clearMap();app.clearText();">Reset Area</button>
          <button class="btn btn-primary " id="submit-button">Create</button>
          </center>
        </div><!--/.sidebar-offcanvas-->

      </div>

      <hr>

      <footer>
        <p>&copy; National Tsing Hua University, ISA6120 - Advanced Database System - Assignment #1 (Adeline, Kojima)</p>
      </footer>


    </div>
  </body>
</html>

